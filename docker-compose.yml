# --- ШАБЛОНЫ (ЯКОРЯ) ---

x-base-service: &base-service
  networks:
    - iot-network

x-java-env: &java-env
  SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES}
  JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS}
  JDK_JAVA_OPTIONS: ${JDK_JAVA_OPTIONS}

x-rabbitmq-env: &rabbitmq-env
  SPRING_RABBITMQ_HOST: ${RABBIT_HOST}
  SPRING_RABBITMQ_USERNAME: ${RABBIT_USER}
  SPRING_RABBITMQ_PASSWORD: ${RABBIT_PASS}

# Шаблон сборки: меняется только путь к Dockerfile
x-build-template: &build-template
  context: .
  dockerfile: Dockerfile

# --- СЕРВИСЫ ---

services:
  iot-analytics:
    <<: *base-service
    build:
      <<: *build-template
      args:
        SERVICE_NAME: iot-analytics
    image: iot-analytics:latest
    container_name: iot-analytics
    ports:
      - "${ANALYTICS_PORT}:${ANALYTICS_PORT}"
    environment:
      <<: [ *java-env, *rabbitmq-env ]
      SERVER_PORT: ${ANALYTICS_PORT}
    depends_on:
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-controller:
    <<: *base-service
    build:
      <<: *build-template
      args:
        SERVICE_NAME: iot-controller
    image: iot-controller:latest
    container_name: iot-controller
    ports:
      - "${CONTROLLER_PORT}:${CONTROLLER_PORT}"
    environment:
      <<: [ *java-env, *rabbitmq-env ]
      SERVER_PORT: ${CONTROLLER_PORT}
      SPRING_DATA_MONGODB_URI: ${MONGO_URI}
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-rule-engine:
    <<: *base-service
    build:
      <<: *build-template
      args:
        SERVICE_NAME: iot-rule-engine
    image: iot-rule-engine:latest
    container_name: iot-rule-engine
    ports:
      - "${RULE_ENGINE_PORT}:${RULE_ENGINE_PORT}"
    environment:
      <<: [ *java-env, *rabbitmq-env ]
      SERVER_PORT: ${RULE_ENGINE_PORT}
    depends_on:
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-data-simulator:
    <<: *base-service
    build:
      <<: *build-template
      args:
        SERVICE_NAME: iot-data-simulator
    image: iot-data-simulator:latest
    container_name: iot-data-simulator
    ports:
      - "${SIMULATOR_PORT}:${SIMULATOR_PORT}"
    environment:
      <<: *java-env
      CONTROLLER_URL: http://iot-controller:${CONTROLLER_PORT}/api/ingest
    depends_on:
      iot-controller:
        condition: service_started
      logstash:
        condition: service_healthy

  # --- ИНФРАСТРУКТУРА ---

  mongodb:
    <<: *base-service
    image: mongo:${MONGO_VERSION}
    container_name: mongodb
    ports:
      - "${MONGO_PORT}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    <<: *base-service
    image: rabbitmq:${RABBIT_VERSION}
    container_name: rabbitmq
    ports:
      - "${RABBIT_MQ_PORT}:5672"
      - "${RABBIT_MGMT_PORT}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS}
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "check_running" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- ELK STACK ---

  elasticsearch:
    <<: *base-service
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: elasticsearch
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: ${ES_JAVA_OPTS}
    ports:
      - "${ES_PORT}:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q status" ]
      interval: 10s
      timeout: 5s
      retries: 10

  logstash:
    <<: *base-service
    image: docker.elastic.co/logstash/logstash:${ELASTIC_VERSION}
    container_name: logstash
    ports:
      - "${LOGSTASH_PORT}:5044"
    volumes:
      - ./elk/logstash/pipeline:/usr/share/logstash/pipeline:ro
    environment:
      LS_JAVA_OPTS: ${LS_JAVA_OPTS}
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9600" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kibana:
    <<: *base-service
    image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION}
    container_name: kibana
    ports:
      - "${KIBANA_PORT}:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      XPACK_SECURITY_ENABLED: "false"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -I http://localhost:5601 | grep -q 'HTTP/1.1 302 Found'" ]
      interval: 10s
      timeout: 5s
      retries: 20

  kibana-setup:
    <<: *base-service
    image: curlimages/curl:${CURL_VERSION}
    container_name: kibana-setup
    depends_on:
      kibana:
        condition: service_healthy
    restart: on-failure
    command: >
      sh -c "sleep 15; curl -X POST 'http://kibana:5601/api/data_views/data_view' -H 'Content-Type: application/json' -H 'kbn-xsrf: true' -d '{\"data_view\": {\"title\": \"logs-*\", \"name\": \"Logs\", \"timeFieldName\": \"@timestamp\"}}'"

  filebeat:
    <<: *base-service
    image: docker.elastic.co/beats/filebeat:${ELASTIC_VERSION}
    container_name: filebeat
    user: root
    volumes:
      - ./elk/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      logstash:
        condition: service_started
    command: [ "filebeat", "-e", "--strict.perms=false" ]

  # --- MONITORING ---

  prometheus:
    <<: *base-service
    image: prom/prometheus:${PROMETHEUS_VERSION}
    container_name: prometheus
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  grafana:
    <<: *base-service
    image: grafana/grafana:${GRAFANA_VERSION}
    container_name: grafana
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  mongo_data:
  elasticsearch_data:
  prometheus_data:
  grafana_data:


networks:
  iot-network:
    driver: bridge
