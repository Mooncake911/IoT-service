# --- ШАБЛОНЫ (ЯКОРЯ) ---

x-base-service: &base-service
  networks:
    - iot-network

x-java-env: &java-env
  JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS}
  JDK_JAVA_OPTIONS: ${JDK_JAVA_OPTIONS}

x-spring-env: &spring-env
  SPRING_SERVER_PORT: ${SPRING_INTERNAL_PORT}
  SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES}

x-rabbitmq-env: &rabbitmq-env
  RABBIT_USER: ${RABBIT_USER}
  RABBIT_PASS: ${RABBIT_PASS}
  RABBIT_HOST: ${RABBIT_HOST}
  RABBIT_MQ_PORT: ${RABBIT_INTERNAL_MQ_PORT}
  RABBIT_MGMT_PORT: ${RABBIT_INTERNAL_MGMT_PORT}
  RABBIT_STOMP_PORT: ${RABBIT_INTERNAL_STOMP_PORT}

x-mongodb-env: &mongodb-env
  MONGO_USER: ${MONGO_USER}
  MONGO_PASS: ${MONGO_PASS}
  MONGO_HOST: ${MONGO_HOST}
  MONGO_DB: ${MONGO_DB}
  MONGO_PORT: ${MONGO_INTERNAL_PORT}
  MONGO_URI: ${MONGO_URI}

# --- СЕРВИСЫ ---

services:
  iot-analytics:
    <<: *base-service
    build:
      context: .
      dockerfile: Dockerfile
      target: iot-analytics
      args:
        SERVICE_NAME: iot-analytics
    image: iot-analytics:latest
    container_name: iot-analytics
    ports:
      - "${ANALYTICS_PORT}:${SPRING_INTERNAL_PORT}"
    environment:
      <<: [ *java-env, *spring-env, *rabbitmq-env ]
    depends_on:
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-controller:
    <<: *base-service
    build:
      context: .
      dockerfile: Dockerfile
      target: iot-controller
      args:
        SERVICE_NAME: iot-controller
    image: iot-controller:latest
    container_name: iot-controller
    ports:
      - "${CONTROLLER_PORT}:${SPRING_INTERNAL_PORT}"
    environment:
      <<: [ *java-env, *spring-env, *rabbitmq-env, *mongodb-env ]
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-rule-engine:
    <<: *base-service
    build:
      context: .
      dockerfile: Dockerfile
      target: iot-rule-engine
      args:
        SERVICE_NAME: iot-rule-engine
    image: iot-rule-engine:latest
    container_name: iot-rule-engine
    ports:
      - "${RULE_ENGINE_PORT}:${SPRING_INTERNAL_PORT}"
    environment:
      <<: [ *java-env, *spring-env, *rabbitmq-env ]
    depends_on:
      rabbitmq:
        condition: service_healthy
      logstash:
        condition: service_healthy

  iot-dashboard:
    <<: *base-service
    build:
      context: ./iot-dashboard
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: iot-dashboard
    image: iot-dashboard:latest
    container_name: iot-dashboard
    ports:
      - "${DASHBOARD_PORT}:8501"
    environment:
      <<: [ *mongodb-env ]
      SIMULATOR_API_URL: http://iot-data-simulator:${SPRING_INTERNAL_PORT}
      RULE_ENGINE_API_URL: http://iot-rule-engine:${SPRING_INTERNAL_PORT}
      CONTROLLER_API_URL: http://iot-controller:${SPRING_INTERNAL_PORT}
      ANALYTICS_API_URL: http://iot-analytics:${SPRING_INTERNAL_PORT}
    depends_on:
      mongodb:
        condition: service_healthy
      iot-controller:
        condition: service_started
      iot-analytics:
        condition: service_started
      iot-data-simulator:
        condition: service_started

  iot-data-simulator:
    <<: *base-service
    build:
      context: .
      dockerfile: Dockerfile
      target: iot-data-simulator
      args:
        SERVICE_NAME: iot-data-simulator
    image: iot-data-simulator:latest
    container_name: iot-data-simulator
    ports:
      - "${SIMULATOR_PORT}:${SPRING_INTERNAL_PORT}"
    environment:
      <<: [ *java-env, *spring-env ]
      CONTROLLER_URL: http://iot-controller:${SPRING_INTERNAL_PORT}/api/ingest
    depends_on:
      iot-controller:
        condition: service_started
      logstash:
        condition: service_healthy

  # --- ИНФРАСТРУКТУРА ---

  mongodb:
    <<: *base-service
    image: mongo:${MONGO_VERSION}
    container_name: mongodb
    ports:
      - "${MONGO_PORT}:${MONGO_INTERNAL_PORT}"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    <<: *base-service
    image: rabbitmq:${RABBIT_VERSION}
    container_name: rabbitmq
    ports:
      - "${RABBIT_MQ_PORT}:${RABBIT_INTERNAL_MQ_PORT}"
      - "${RABBIT_MGMT_PORT}:${RABBIT_INTERNAL_MGMT_PORT}"
      - "${RABBIT_STOMP_PORT}:${RABBIT_INTERNAL_STOMP_PORT}"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASS}
    command: >
      sh -c "rabbitmq-plugins enable rabbitmq_web_stomp && rabbitmq-server"
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "check_running" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- ELK STACK ---

  elasticsearch:
    <<: *base-service
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: elasticsearch
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: ${ES_JAVA_OPTS}
    ports:
      - "${ES_PORT}:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q status" ]
      interval: 10s
      timeout: 5s
      retries: 10

  logstash:
    <<: *base-service
    image: docker.elastic.co/logstash/logstash:${ELASTIC_VERSION}
    container_name: logstash
    ports:
      - "${LOGSTASH_PORT}:5044"
    volumes:
      - ./elk/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./elk/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
    environment:
      LS_JAVA_OPTS: ${LS_JAVA_OPTS}
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9600" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  kibana:
    <<: *base-service
    image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION}
    container_name: kibana
    ports:
      - "${KIBANA_PORT}:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      XPACK_SECURITY_ENABLED: "false"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -I http://localhost:5601 | grep -q 'HTTP/1.1 302 Found'" ]
      interval: 10s
      timeout: 5s
      retries: 20

  kibana-setup:
    <<: *base-service
    image: curlimages/curl:${CURL_VERSION}
    container_name: kibana-setup
    depends_on:
      kibana:
        condition: service_healthy
    restart: on-failure
    command: >
      sh -c "sleep 15; curl -X POST 'http://kibana:5601/api/data_views/data_view' -H 'Content-Type: application/json' -H 'kbn-xsrf: true' -d '{\"data_view\": {\"title\": \"logs-*\", \"name\": \"Logs\", \"timeFieldName\": \"@timestamp\"}}'"

  # --- MONITORING ---

  prometheus:
    <<: *base-service
    image: prom/prometheus:${PROMETHEUS_VERSION}
    container_name: prometheus
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  grafana:
    <<: *base-service
    image: grafana/grafana:${GRAFANA_VERSION}
    container_name: grafana
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  mongo_data:
  elasticsearch_data:
  prometheus_data:
  grafana_data:


networks:
  iot-network:
    driver: bridge
